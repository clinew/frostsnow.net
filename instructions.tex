\documentclass{article}

\usepackage{listings}
\lstset{basicstyle=\ttfamily}

\begin{document}

\title{Connecting to the \texttt{CotSS} IRC Service}

\maketitle

\section{Introduction}
IRC (Internet Relay Chat) is a protocol that allows users to communicate over the Internet; specifically, it allows a \textit{client} (you) to communicate with a \textit{server} (\texttt{CotSS}, located at \texttt{frostsnow.net}).  By itself, IRC sends information in \textit{plaintext}, meaning that anyone can view and even modify said information.  In order to prevent this, the IRC protocol can be encapsulated by the TLS (Transport Layer Security) protocol, which turns the plaintext into \textit{ciphertext} which can be neither read (giving \textit{confidentiality}) nor modified (giving \textit{integrity}).  In addition, TLS provides \textit{authenticity}, which verifies the server to the client (letting the client know that it is indeed communicating with \texttt{CotSS} and not an imposter) and optionally verifies the client to the server (letting the server know that it is talking with a specific client).  Lastly, TLS provides \textit{authorization}, which verifies that the client is allowed to connect to the server.  This guide will show you how to use TLS to connect to the \texttt{CotSS} IRC server.

TLS uses a type of cryptography often referred to as "Public-Private Key" Cryptography (formally \textit{Asymmetric} Cryptography), because each party has a pair of keys.  A \textit{public} key is shared between parties while a \textit{private} key is kept secret.  In TLS, the public key is called a \textit{certificate} (more specifically, an \textit{X.509} certificate).  Therefore, in order to communicate with \texttt{CotSS}, you will need three things: 1) the server's certificate, in order for you to verify that the computer you are talking to is in fact \texttt{CotSS}; 2) your certificate, in order for the server to verify that it is talking to you; and 3) your private key, in order to verify to the server that you are the proper owner of the certificate.  Note that the server will use its private key in order to verify to you that it is the proper owner of its certificate.

\section{Connecting}
Connecting will involve two steps: 1) verifying the server to yourself, and 2) verifying yourself to the server.
\subsection{Server Verification}
Verifying the server to yourself will also consist of two steps: 1) obtaining a trusted copy of the server's certificate, and 2) configuring your client to use said certificate.

Ideally, you would obtain a trusted certificate by either obtaining and verifying its GPG (GNU Privacy Guard) signature with a previously-verified public key or by physically obtaining a trusted copy from me.  Alas, the former is outside the scope of this document and the latter is rather cumbersome for both of us, so in most cases you'll simply connect to \texttt{CotSS} over the Internet, obtain the certificate that is presented to you, and use that, but do keep in mind that if your first connection was to an imposter, all subsequent connections will be vulnerable to same imposter, thus you should make an attempt to verify the certificate if you are able to do so.

In order to get the certificate, run the commands:
\begin{lstlisting}
    $ mkdir ~/irc
    $ openssl s_client -connect frostsnow.net:6697 2> \
        /dev/null | sed -n '/BEGIN CERT/,/END CERT/p' \
	> ~/irc/cotss.pem
\end{lstlisting}
The \texttt{\$} denotes the beginning of a command.  The first command create a directory named \texttt{irc} in your home directory.  The second command should retrieve the certificate from \texttt{CotSS}.  The \texttt{openssl} command consists of a series of subcommands; the \texttt{s\_client} command acts as a client to a server, \texttt{-connect frostsnow.net:6697} tells the client to connect to \texttt{frostsnow.net} on port \texttt{6697}, which is where \texttt{CotSS} is located.  \texttt{2> /dev/null} redirects extra crap into a void from which it does not return, \texttt{| sed -n '/BEGIN CERT/,/END CERT/p'} filters the output of the command to only include the lines encoding the certificate, and \texttt{> \textasciitilde/irc/cotss.pem} takes the filtered output and places it in the file \texttt{cotss.pem} within the \texttt{irc} directory.  The backslash denotes that the command continues onto the next line; you may omit them and place the entire command on a single line.

You'll want to verify that you have actually recieved a certificate (for example, there may be a network error).  You can run:
\begin{lstlisting}
	$ cat ~/irc/cotss.pem
\end{lstlisting}
\ldots which should show a text file beginning with \texttt{-----BEGIN CERTIFICATE-----}, followed by a bunch of text, and ending with \texttt{-----END CERTIFICATE-----}.  In order to actually view the contents of the certificate, run the command:
\begin{lstlisting}
	$ openssl x509 -in ~/irc/cotss.pem -text -noout
\end{lstlisting}
\ldots which should then show various information about the certificate.  For extra fun, perform the same steps except use \texttt{google.com:8080} instead of {\texttt{frostsnow.net:6697}.

Now that you have a copy of the server's certificate, you need to tell your IRC client to use it as a \textit{Certificate Authority} (CA); Certificate Authorities determine which certificates are valid (roughly speaking).  This step of configuring your IRC client is client-specific, in other words, different clients will have different methods of configuration.  This guide will use the \texttt{irssi} client; if you are using another client, you will need to look at its documentation in order to figure out how to perform this step.  In order to connect using the certificate you've downloaded, launch the \texttt{irssi} program and connect with the command:
\begin{lstlisting}
    /connect -ssl_verify -ssl_cafile ~/irc/cotss.pem \
        frostsnow.net 6697
\end{lstlisting}
This will instruct \texttt{irssi} to connect to \texttt{frostsnow.net}, port \texttt{6697} (again, where \texttt{CotSS} is located) using the file \texttt{\textasciitilde/irc/cotss.pem} as a Certificate Authority, after which you will propmpty be disconnected from the server as you have not yet provided a valid client certificate, which is the topic of the next section.  Go ahead and type \texttt{/rmreconns} to prevent \texttt{irssi} from trying in vain to reconnect to the server.

\subsection{Client Verification}
Creating a client certificate is rather more involved than getting the server's certificate, in large part because you must both store a \textit{secret} key and you must also have your certificate \textit{signed} by the appropriate certificate authority.  In total, there are five steps: 1) Generating a private key, 2) Generating a certificate signing request, 3) Sending the certificate signing request, 4) Recieving the signed certificate, and 5) Configuring your client to use the signed certificate and private key.

Generating the key is simple enough: the one trick is to make sure that no other user on the system has read permission on the key, as that would defeat the point of the key being \textit{secret} (note that even if you are the only real person that logs into your system, most GNU\textbackslash Linux systems are configured with multiple users for security purposes).  In order to generate the secret key, run the following three commands:
\begin{lstlisting}
    $ umask 0077
    $ openssl genrsa -out ~/irc/key.pem 4096
    $ umask 0022
\end{lstlisting}
The first command, \texttt{umask 0077} prevents any file created from being accessible in any way whatsoever to other users.  The second command generates an \textit{RSA} key of length 4096 bits.  The third command (optional) prevents any file created from being writable by other users.  As you may have guessed, this command will create the secret key for you in the location \texttt{\textasciitilde/irc/key.pem}; it is important to keep this file to yourself and never reveal it to anyone, as part of the magic of asymmetric cryptography relies on the fact that only you have access to this file (not even the server knows your secret key).

Second, use the secret key to generate a \textit{certificate signing request} that will be sent to the appropriate certificate authority (you should know who this is).  The command is simple enough, but note that it will begin asking you for large amounts of beaurcratic bullshit that we don't care about; you should omit most of these fields by entering a ``\texttt{.}'' in them \textbf{except} the ``Common Name'' field, in which you should place your \textit{Erisian Holy Name} (think: ``nickname'').  Do not set a challenge password (leave that field blank).  The command itself is:
\begin{lstlisting}
    $ openssl req -key ~/irc/key.pem -sha512 -new \
        -out ~/irc/csr.pem
\end{lstlisting}
This command uses the \texttt{req} subcommand in order to generate the certificate signing request; \texttt{-key \textasciitilde/irc/key.pem} uses the previously-generated key in generating the request, \texttt{-sha512} uses the SHA-512 hash in the requet, \texttt{-new} specifies that we are generating a new request, and \texttt{-out \textasciitilde/irc/csr.pem} specifies where the generated request is output.

Thirdly, now that you have your certificate signing request, you must get it signed (obviously).  Ideally, this should be done in the same way as for validating the server certificate: either using GPG signatures with a previously-verified public key or by physically exchanging the files in person.  In practice, you'll probably just e-mail it like a lazy fuck.  You ought to know how to do that.

Fourthly, you will obtain the signed certificate using whatever method you've employed.  It will probably be called \texttt{yournick.pem} or \texttt{cert.pem}.  There isn't really anything that needs to be done here besides placing the signed certificate at \texttt{\textasciitilde/irc/yournick.pem}, but it's worth viewing the contents of the certificate with:
\begin{lstlisting}
    $ openssl x509 -in ~/irc/yournick.pem -text -noout
\end{lstlisting}
Of interest is the ``Issuer'' (the person who signed the certificate) and the ``Subject'' (you).

Lastly, you must configure your client to use both the signed certificate and your secret key.  As with setting up the server certificate, these instructions are specific to the \texttt{irssi} client and if you are using a different client then you will need to adapt the instructions to your client.  Also, the following command will assume that you have successfully obtained and verified the server's certificate as per the preceding section.  Now, in order to use your newly-obtained client certificate, start \texttt{irssi} and run the following command (without backslashes and all on one line):
\begin{lstlisting}
    /connect -ssl_verify -ssl_capath ~/irc/cotss.pem \
        -ssl_cert ~/irc/yournick.pem \
	-ssl_pkey ~/irc/key.pem \
	frostsnow.net 6697
\end{lstlisting}
The additional arguments, \texttt{-ssl\_cert \textasciitilde/irc/yournick.pem} and \texttt{-ssl\_pkey \textasciitilde/irc/key.pem} specify your client certificate and your private key, respectively.  After running the command, you should now be connected to IRC!\footnote{If not then curse, take a deep breath, and carefully re-read the instructions.  Failing that, feel free to contact someone knowledgeable for help.}

\section{Using \texttt{irssi}}
This section provides a quick introduction for using the \texttt{irssi} client.  If you already know how to use \texttt{irssi} or some other IRC client then you may skip this section.

\subsection{Autoconnect}
Unless you are a fan of circumlocution, you probably do not wish to re-type the preceding \texttt{/connect} command every time you connect to \texttt{CotSS}, thus it makes sense to configure \texttt{irssi} to connect automatically on startup.  In order to do this it must first be understood that IRC consists of a \textit{network} of interconnected \textit{servers}.  Therefore, in order to set up autoconnect we must tell \texttt{irssi} both the network \textbf{and} the server that we are connecting to.  For \texttt{CotSS}, which has only one server, this seems rather redundant, but remember that most IRC networks consist of multiple servers and thus \texttt{irssi} reflects this fact.  Start by running the command:
\begin{lstlisting}
    /network add cotss
\end{lstlisting}
\ldots which adds a network with the name \texttt{cotss}.  Next add the server to the \texttt{cotss} network:
\begin{lstlisting}
    /server add -auto -network cotss -ssl_verify \
        -ssl_cafile ~/irc/cotss.pem \
	-ssl_cert ~/irc/yournick.pem \
	-ssl_pkey ~/irc/key.pem \
	-port 6697 frostsnow.net
\end{lstlisting}
This mirrors the \texttt{/connect} command, except instead of connecting it is configuring \texttt{irssi} to automatically connect to the server with the given arguments on startup.  Save the configuration with:
\begin{lstlisting}
    /save
\end{lstlisting}
\ldots and then restart \texttt{irssi} to automatically connect!

\subsection{Navigation}
\texttt{irssi} is divided into \textit{windows}, which can contain either \textit{channels} or \textit{private messages}.  Windows are \textit{numbered}, with window number \texttt{1} holding status messages and subsequent windows numbered sequentially after that (\texttt{2}, \texttt{3}, \texttt{4}, \ldots).  You can join channels by running \texttt{/join <channelname>} where \texttt{<channelname>} is, obviously, the name of the channel that you wish to join; note that, in IRC, channels start with a \texttt{\#} symbol (which is \textbf{not} a Twatter hashtag).  Likewise, you may message users by typing \texttt{/msg <username>} where \texttt{<username>} is, obviously, the nickname of the user that you wish to message.  Both of these actions will open up a new window (\texttt{/join} will actually \textbf{activate} that window), and you can then navigate between windows by either typing \texttt{/window <number>} or by pressing \texttt{Alt+<number>} (depending on your terminal) where \texttt{<number>} is the number of the window that you wish to activate.  More information and options may be found by typing \texttt{/help window}.

\section{NickServ}
By default, anyone may use any nickname that is not currently in use after connecting to IRC.  In order to claim ownership of a nickname, one must \textit{register} it with \textit{services} by messaging the bot named \texttt{NickServ} and then \textit{identify} to that nickname on subsequent connections.  The easiest way to do this on \texttt{cotss} is to 1) register with \texttt{NickServ} and then 2) identify using your client certificate.  In order to register, run the following command while on the nick that you wish to register:
\begin{lstlisting}
    /msg NickServ register <your_password> \
        <your_bogus_email>
\end{lstlisting}
\ldots where \texttt{<your\_password>} should be a \textbf{unique} password for your account (don't send me a password that you've previously used elsewhere, that's just stupid) and \texttt{<your\_bogus\_email>} is some gibberish (all e-mail functionality has been disabled for \texttt{cotss}).  After that, you may manually identify to \texttt{NickServ} on subsequent connections by running the command:
\begin{lstlisting}
    /msg NickServ identify <your_password>
\end{lstlisting}
\ldots but that's a pain, so the easier option is to add your client certificate's \textit{fingerprint}, which is a unique identifier for that certificate, to \texttt{NickServ}'s list of valid fingerprints for your account.  You can obtain your certificate's fingerprint by running the following command:
\begin{lstlisting}
    $ openssl x509 -noout -fingerprint \
        -in ~/irc/yournick.pem \
	| sed s/.*=// \
	| sed s/\://g \
	| sed y/ABCDEF/abcdef
\end{lstlisting}
\ldots then use the output of that command as input to the following \texttt{irssi} command:
\begin{lstlisting}
    /msg NickServ cert add <fingerprint>
\end{lstlisting}
\ldots which will add the fingerprint to \texttt{NickServ}'s list of valid client certificate fingerprints for your account.  More information about \texttt{NickServ}'s services may be found by running \texttt{/msg NickServ help}.

\section{Inviting Friends}
Depending on your client certificate's \textit{extensions}, you may be able to \textit{sign} additional client certificates, thereby inviting your friends to \texttt{cotss}.  The policy for invites is dubbed \textit{friend-of-friend}, meaning that, if you are a friend me, the server admin, you may also invite your friends to join (taking into consideration that they aren't dicks, obviously), thus those that may be invited are the "friend of a friend".  Sadly, the method for signing certificates is a pain-in-the-ass, mainly because you need to set up a directory as a \textit{Certificate Authority}, including an OpenSSL configuration file,  before you are able to sign certificates from that directory; this section of the guide will walk you through that process.

\subsection{Viewing Certificate Extensions}
First, you'll probably wish to confirm that you are able to validly sign certificates of your friends before embarking on this endeavor.  In order to do this, you must view the \textit{X509v3 extensions} of your client certificate, which may be done by running:
\begin{lstlisting}
    $ openssl x509 -in ~/irc/yournick.pem -text \
        -noout | grep -A1 "Basic Constraints"
\end{lstlisting}
You should be familiar with the first part of this command by now; the second part, \texttt{grep -iA1 "Basic Constraints"}, acts as a filter to limit the input to what we're interested in\footnote{If you get no output, make sure you spelled "Basic Constraints" precisely, or try removing that part of the command and searching the output yourself.}.  The two fields (comma-separated) that we are interested in are the \texttt{CA} and \texttt{pathlen} fields: the first of field, \texttt{CA}, is a \textit{boolean} (either true or false) specifying whether or not one is a Certificate Authority and thus able to sign certificates (\texttt{TRUE} if one is able to sign certificates and \texttt{FALSE} if one is not able to sign certificates); the second field, \texttt{pathlen}, is an integer that specifies how many more Certificate Authorities you may create with your certificate, and thus ought to be either omitted or \texttt{0} (you may sign additional certificates, but the certificates that you sign are not also able to sign additional certificates).  The two valid combination are \texttt{CA:TRUE,pathlen:0}, thus you may invite people by signing additional certificates, and \texttt{CA:FALSE}, thus you may not invite people.

\subsection{Creating a CA}
You must set up a special directory for your Certificate Authority; we'll use \texttt{\textasciitilde /irc/ca}.  Run the following series of commands:
\begin{lstlisting}
    $ mkdir ~/irc/ca
    $ cd ~/irc/ca
    $ mkdir certs crl csr newcerts
    $ umask 0077
    $ mkdir private
    $ umask 0022
    $ touch index.txt
    $ echo 1000 > serial
    $ echo 1000 > crlnumber
\end{lstlisting}
You will also need to create an OpenSSL configuration file for your CA, please copy the file from Appendix \ref{appendix_a} into \texttt{\textasciitilde /irc/ca/openssl.cnf}.  The file is divided into square-bracket (\texttt{[]}) delimited \textit{sections}, of which a brief description is as follows: the \texttt{ca} section declares the default Certificate Authority section; the \texttt{ca\_default} section declares various attributes of a Certificate Authority; the \texttt{policy\_anything} section defines which fields of a certificate signing request must be specified in order for a CA to sign said request;  the \texttt{v3\_friend} section defines extensions that a signed certificate will have.

Your CA directory will expect your client certificate and private key to be in certain locations, you may either move them there (and then update your IRC client's configuration appropriately) or create a symbolic link to their actual locations; the following command does the latter:
\begin{lstlisting}
    $ cd ~/irc/ca
    $ ln -s ../yournick.pem certs/cert.pem
    $ ln -s ../key.pem private/key.pem
\end{lstlisting}
Your Certificate Authority should now be set up, but keep in mind that you will need to remember to manually specify the configuration file when you are using it, as is done in the following subsection.

\subsection{Signing Friend's Certificates}
In order to sign your friend's certificate, they must first create a \textit{certificate signing request} (csr), as explained earlier in this guide, and then send the signing request to you.  When you receive the signing request and place it in \texttt{\textasciitilde /irc/ca/csr/yourfriend.pem} (with \texttt{yourfriend.pem} replaced by the nick of your friend), you should first verify that it is of the appropriate key \textit{length} and has the correct \textit{Common Name} before signing it by running:
\begin{lstlisting}
    $ openssl req -in ~/irc/ca/csr/yourfriend.pem \
        -text -noout
\end{lstlisting}
\ldots and making sure that the ``Public-Key'' reads \texttt{4096 bit} (and not, say, \texttt{2048 bit} or lower) and that the ``Subject'' line reads something akin to \texttt{Subject: CN=yourfriend}\footnote{Note that key lengths below \texttt{4096} \textit{may} be accepted by the server as-is, but are not supported and may break at any time, as weak crypto will be deprecated today and not tomorrow.}.

Now that you've verified the certificate signing request, you may sign the certificate using your Certificate Authority by running the following commands:
\begin{lstlisting}
    $ cd ~/irc/ca
    $ openssl ca -config openssl.cnf \
        -extensions v3_fof \
        -in csr/yourfriend.pem \
        -out certs/yourfriend.pem
\end{lstlisting}
The \texttt{-extensions v3\_fof} tells OpenSSL to use the X509v3 extensions with the label \texttt{v3\_fof}, which is in the \texttt{openssl.cnf} file as specified by \texttt{-config openssl.cnf}.  The arguments which specify the input certificate signing request and the output client certificate should be self-explanatory.  You may wish to verify the output client certificate by running \texttt{openssl x509 -in certs/yourfriend.pem -text -noout}; the output certificate should have a long expiration time (for your and their convenience), and also have a 4096-bit length key and be signed with SHA-512 and not, say, SHA-256\footnote{Check the \texttt{Signature Algorithm} line in the certificate, and note that, although it may work with SHA-256 initially, weak crypto will be deprecated today and not tomorrow.} (your configuration file should guarantee this).

Then all you need to do is send your friend their signed client certificate, and they will be able to connect!

\pagebreak
\appendix
\section{OpenSSL CA Configuration File}
\label{appendix_a}
You may also find this file included in the repository containing these instructions\footnote{\texttt{https://github.com/clinew/frostsnow.net} at the time of this writing.}.
\lstinputlisting[basicstyle=\scriptsize\ttfamily]{openssl.cnf}

% Explain some entries in the CA configuration file
% Actually test instructions.

\end{document}
